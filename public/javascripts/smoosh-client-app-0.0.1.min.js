
$(document).ready(function(){function f(a){var b=this;b.id=a._id,b.title=ko.observable(a.title),b.isDone=ko.observable(a.isDone),b.priority=ko.observable(a.priority),b.editMode=ko.observable(!1),b.editingTitle=ko.observable(),b.editingPriority=ko.observable(),b.from=ko.observable(a.from)}function g(a){var b=this;b.id=a.id,b.screenName=a.screenName,b.online=a.online}function h(a){var b=this;b.id=a.id,b.name=a.name,b.screenName=a.screenName,b.email=a.email,b.online=ko.observable(a.online),b.logoutUrl=ko.observable("/logout?uid="+a.id),b.mainUrl=ko.observable("/main/#uid/"+a.id),b.tasks=ko.observableArray([]),b.buddies=ko.observableArray([]);var h=$.map(a.tasks,function(a){return new f(a)});b.tasks(h);var i=$.map(a.buddies,function(a){return new g(a)});b.buddies(i),b.newTaskText=ko.observable(),b.newTaskPriority=ko.observable();var j=function(a,b,c){a.status==403?$.jnotify("Session Expired. Please login again.",{type:"warning",remove:function(){window.location.replace("/")}}):a.status==400?$.jnotify("URL tampering not allowed. Please login again.",{type:"error",remove:function(){window.location.replace("/")}}):$.jnotify("Oops!! Something snapped. Please try again.","error")},k=function(a,c){var e=d.replace(":id",b.id).replace(":tid",a.id),f=ko.toJSON(a);$.ajax({type:"PUT",url:e,data:f,contentType:"application/json",processData:!1,success:c,error:j})};b.addTask=function(){var a=new f({title:b.newTaskText(),priority:b.newTaskPriority(),isDone:!1}),d=ko.toJS(a),e=c.replace(":id",b.id),g=$.post(e,d,function(c,d,e){a.id=c._id,b.tasks.push(a)}).error(j);b.newTaskText(""),b.newTaskPriority("now")},b.removeTask=function(a){var c=d.replace(":id",b.id).replace(":tid",a.id),e=ko.toJSON(a);$.ajax({type:"DELETE",url:c,success:function(c,d,e){b.tasks.remove(a)},error:j})},b.edit=function(a){a.editMode(!0),a.editingTitle(a.title()),a.editingPriority(a.priority())},b.cancel=function(a){a.editMode(!1),a.title(a.editingTitle()),a.priority(a.editingPriority())},b.editSave=function(a){k(a,function(){a.editMode(!1)})},b.toggleCompletion=function(a){return k(a,$.noop),!0},b.getBuddies=function(){var a=e.replace(":id",b.id);$.getJSON(a,function(a){var c=$.map(a,function(a){return new g(a)});b.buddies(c)})},b.onAfterRenderTask=function(a,b){$(a).find(".icon-share-alt").draggable({opacity:.7,helper:function(a){return $('<span class="label label-warning" id="'+b.id+'">'+b.title()+"</span>")}})},b.onAfterRenderBuddy=function(a,c){$(a).droppable({drop:function(a,c){var e=c.draggable[0].id,f=d.replace(":id",b.id).replace(":tid",e),g=ko.toJSON({uid:$(this).attr("id")}),h=ko.utils.arrayFirst(b.tasks(),function(a){return e===a.id});$.ajax({type:"PUT",url:f,data:g,contentType:"application/json",processData:!1,error:j,success:function(a,c,d){b.tasks.remove(h)}}),$(this).effect("drop",function(){$(this).removeAttr("style").hide().effect("slide")})}}),$(a).addClass(c.online?"buddy-online":"buddy-offline")},b.priorities=["now","soonish","later","wish"]}function l(){var a=io.connect("http://local.host/"+j);a.on("online",function(a){console.log("Who got online? "+a)}),a.on("offline",function(a){console.log("Who went offline? "+a)})}var a=null;ko.bindingHandlers.popover={init:function(a,b,c,d){var e=b()||{};$(a).popover(e)}};var b="/users/:id",c="/users/:id/tasks",d="/users/:id/tasks/:tid",e="/users/:id/buddies",i=$.url(),j=i.param("uid"),k=b.replace(":id",j);$.getJSON(k,function(b){a=new h(b),ko.applyBindings(a),l()})})